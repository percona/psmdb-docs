# Telemetry on Percona Server for MongoDB

Percona wants to learn more about how people use their software. This telemetry feature helps them understand what features users use the most if there are any problems, and how Percona can improve their software in the future. 

You can choose not to share this information. Participation in this program is completely voluntary. If you're uncomfortable sharing this anonymous data, you can [disable telemetry](#disable-telemetry).

Your privacy is protected. Percona doesn't collect any personal information about you. All collected data is anonymous, meaning it can't be traced back to any individual user. To learn more about how Percona handles your data, read the [Percona Privacy statement](https://www.percona.com/privacy-policy).

Currently, telemetry is added only to the Percona packages for both basic and Pro builds and to Docker images. 

## What information is collected

Percona collects information using the following components:

* The Telemetry subsystem collects the necessary metrics directly from the database and stores them in a Metrics file.

* The Metrics file stores the metrics and is a standalone file located on the database host's file system.

* The Telemetry Agent is an independent process running on your database host's operating system and carries out the following tasks:

    * Collects OS-level metrics

    * Reads the Metrics file, adds the OS-level metrics

    * Sends the full set of metrics to the Percona Platform

The telemetry also uses the Percona Platform with the following components:

* Telemetry Service - offers an API endpoint for sending telemetry. The service handles incoming requests. This service saves the data into Telemetry Storage.

* Telemetry Storage - stores all telemetry data for the long term.

### Telemetry subsystem

The Telemetry subsystem extends the functionality of the database. It can be implemented in the following ways, depending on the database:

* Modification to the source code

* Modular components added to the database

* Self-contained extensions

Percona Server for MongoDB has a built-in Telemetry subsystem implemented separately for `mongod` and `mongos` instances. It is enabled by default during the initial database deployment.

Telemetry subsystem does not collect the following information:

* database names

* user names or credentials

* any user-entered value

The Telemetry subsystem sends metrics gathered from the database instance to the Metrics file. This information is collected every 24 hours. Each collection creates a new Metrics file. When the file date exceeds seven days, the component removes the outdated files before creating the new file.

The component creates a file in the local file system using a timestamp as the name with a `.json` extension.

### Metrics file

Percona stores the Metrics file in one of the following directories on the local file system. The location depends on the product.

* Telemetry root path - `/usr/local/percona/telemetry`

* Percona Server for MongoDB has two root paths since the telemetry subsystem is enabled both for the `mongod` and `mongos` instances. The paths are the following:  

    * `mongod` root path -  `${telemetry root path}/psmdb/`
    * `mongos` root path -  `${telemetry root path}/psmdbs/`

* PS root path -   `${telemetry root path}/ps/`

* PXC root path - `${telemetry root path}/pxc/`

* PG root path - `${telemetry root path}/pg/`

* Percona ToolKit - `${telemetry root path}/toolkit/`

Percona archives the telemetry history in `${telemetry root path}/history/`.

#### Metrics file format

The Metrics file uses the Javascript Object Notation (JSON) format. Percona reserves the right to extend the current set of JSON structure attributes in the future.


=== "`mongod` Metrics file"

    The following is an example of the collected data generated by the `mongod` instance of the config server replica set of the sharded cluster:    

    ```json
    {
        "source": "mongod",
        "pillar_version": "7.0.0",
        "pro_features": [],
        "db_instance_id": "65e9977d58deb2f66faa591c",
        "db_internal_id": "65e9977d58deb2f66faa591c",
        "db_cluster_id": "65e997cb58deb2f66faa5954",
        "shard_svr": "true",
        "config_svr": "true",
        "uptime": "102",
        "storage_engine": "wiredTiger",
        "db_replication_id": "65e997cb58deb2f66faa5944",
        "replication_state": "PRIMARY"
    }
    ```

=== "`mongos` Metrics file"

    The following is an example of the collected data generated by the `mongos` instance. 

    ```json
    {
        "source": "mongos",
        "pillar_version": "7.0.0",
        "pro_features": [],
        "db_instance_id": "6690fea9066216c6d9d77044",
        "uptime": "4",
        "db_cluster_id": "6690fea65d86eb061c0bd728"
    }
    ```

### Telemetry Agent

The Percona Telemetry agent functions as a dedicated OS daemon process. The service name on the operating system is `percona-telemetry-agent`. The agent can create, read, write, and delete files in the `${telemetry root path}` and only interacts with JSON files.

The agent sends the collected information as a file to the Percona Platform every 24 hours. If the attempt fails, the agent tries again after a defined period with a limit of five attempts. After a successful transmission, the agent deletes the file.

The agent does not send anything if no Percona-specific files are in the target directory.

The following is an example of a telemetry agent payload:

```json
{
  "reports": [
    {
      "id": "B5BDC47B-B717-4EF5-AEDF-41A17C9C18BB",
      "createTime": "2023-09-01T10:56:49Z",
      "instanceId": "B5BDC47B-B717-4EF5-AEDF-41A17C9C18BA",
      "productFamily": "PRODUCT_FAMILY_PS",
      "metrics": [
        {
          "key": "OS",
          "value": "Ubuntu"
        },
        {
          "key": "pillar_version",
          "value": "7.0.0"
        }
      ]
    }
  ]
}
```

The agent sends information about the database and metrics.

| Key | Description |
|---|---|
| "id" | A generated Universally Unique Identifier (UUID) version 4 |
| "createTime" | UNIX timestamp |
| "instanceId" | The DB Host ID. The value can be taken from the `instanceId`, the `/usr/local/percona/telemetry_uuid` or generated as a UUID version 4 if the file is absent. |
| "productFamily" | The value from the file path |
| "metrics" | An array of key:value pairs collected from the Metrics file.

The following operating system-level metrics are sent with each check:

| Key | Description |
|---|---|
| "OS" | The name of the operating system |
| "hardware_arch" | The type of process used in the environment |
| "deployment" | How the application was deployed. <br> The possible values could be "PACKAGE" or "DOCKER". |
| "installed_packages" | A list of the installed Percona packages.|

The information includes the following:

* Package name

* Package version - the same format as Red Hat Enterprise Linux or Debian

* Package repository - if possible

The package names must fit the following pattern:

* `percona-*`

* `Percona-*`

* `proxysql*`

* `pmm`

* `etcd*`

* `haproxy`

* `patroni`

* `pg*`

* `postgis`

* `wal2json`

## Disable telemetry

Percona software you just installed collects information about how you use it (telemetry) by default. Here's how to turn it off:

### Within the first 24 hours

This is the easiest option. You have 24 hours to disable telemetry before any information is collected or sent.

Use the following command to turn it off:

```{.bash data-prompt=$}
$ sudo systemctl stop percona-telemetry-agent
```

Even after stopping the telemetry agent service, a different part of the software (Telemetry subsystem) continues to create the Metrics file related to telemetry every day and saves that file for seven days.

### Disable the Telemetry subsystem

To disable the Telemetry subsystem, set the `perconaTelemetry` server parameter to `false`. You can do this in one of the following ways:

=== ":octicons-file-code-24: Configuration file"

    Use the `setParameter` admonitions in the configuration file
    for persistent changes:    

    ```yaml
    setParameter:
      perconaTelemetry: false
    ```

=== ":material-console: Command line"

    Use the `--setParameter` command line option arguments for both `mongod` and `mongos` processes. The command applies the changes persistently:    

    ```{.bash data-prompt="$"}
    $ mongod \
      --setParameter perconaTelemetry=false
    $ mongos \
      --setParameter perconaTelemetry=false
    ```

=== ":simple-mongodb: `setParameter` command"    

    Use the `setParameter` command on the `admin` database
    to make changes at runtime. The changes apply until the server restart.

    ```{.javascript data-prompt=">"}
    > db.adminCommand({setParameter: 1, "perconaTelemetry": false})
    ```

!!! tip

    If you wish to re-enable the Telemetry subsystem, set the `perconaTelemetry` to `true` for the `setParameter` command.


### To disable telemetry in Docker

When you start a container, the telemetry is enabled by default. To disable it, add the environment variable when running a command in a new container.
    
```{.bash data-prompt="$"}
$ docker run -d --name psmdb --restart always \
  -e PERCONA_TELEMETRY_DISABLE=1 \
  percona/percona-server-mongodb:<TAG>-multi
```

The command does the following:

* `docker run` - This is the command to run a Docker container.
* `-d` - This flag specifies that the container should run in detached mode (in the background).
* `--name psmdb` - Assigns the name “psmdb” to the container.
* `--restart always` - Configures the container to restart automatically if it stops or crashes.
* `-e PERCONA_TELEMETRY_DISABLE=1` - Sets an environment variable within the container. In this case, it disables telemetry for Percona Server for MongoDB.
* `percona/percona-server-mongodb:<TAG>-multi` - Specifies the image to use for the container. For example, `{{release}}-multi`. The `multi` part of the tag serves to identify the architecture (x86_64 or ARM64) and use the respective image.